\documentclass{ecnreport}

\stud{OD Robotique 2015-2016}
\topic{Robotique Aérienne et Sous-Marine}

\begin{document}

\inserttitle{Robotique Aérienne et Sous-Marine\newline }

\insertsubtitle{Simulation d'un sous-marin}



\section{Content of this lab}

The goal of this lab is to design a thruster-propelled Autonomous Underwater Vehicle (AUV). After the geometric design, a rough approximation of the hydrodynamic damping will be computed
and low-level control (PID's) will be tuned. At the end, the AUV should be able to follow a trajectory defined with a sequence of waypoints.

\subsection{Installing the simulator}

The simulator is a ROS package and can be installed in the \texttt{ros/src} directory with:
\begin{center}\defaultstyle
\begin{lstlisting}
git clone -b moving_thrusters https://github.com/freefloating-gazebo/freefloating_gazebo.git
\end{lstlisting}
\end{center}

The actual package that you will modify is downloaded with:
\begin{center}\defaultstyle
\begin{lstlisting}
git clone https://github.com/oKermorgant/ecn_rasom.git
\end{lstlisting}
\end{center}
This package has the classical ROS structure:
\begin{figure}[h]
\begin{minipage}{.25\linewidth} ~ \end{minipage}
\begin{minipage}{.5\linewidth}
 \dirtree{%
.1 ecn\_rasom. 
.2 config.
.3 ecn\_auv\_control.yaml.
.2 launch.
.3 auv.launch.
.2 subject.
.2 urdf.
.3 ecn\_auv.xacro.
.2 package.xml.
.2 CMakeLists.txt.
} 
\end{minipage}
%\begin{minipage}{.2\linewidth} ~ \end{minipage}
\caption{Files used by the simulator}
\end{figure}

The files to be modified are:
\begin{enumerate}
 \item \texttt{ecn\_auv.xacro}: defines the geometry of the AUV
 \item \texttt{ecn\_auv\_control.yaml}: PID gain tuning
\end{enumerate}
You will also have to write a .cpp file for the waypoint following, and compile it by updating \texttt{CMakeLists.txt}.



\section{Definition of a robot in \texttt{xacro} format}

\subsection{Basics of URDF}

The \texttt{xacro} format allows using variables to generate the URDF model of a robot. 
In this format, the robot is composed of links and joints. In our case we will assume that the AUV has only one link and no joints.

In the example the AUV is composed of one cylinder, which is described under the \texttt{visual} tag.
A tutorial is available at \texttt{http://wiki.ros.org/urdf/Tutorials/Building a Visual Robot Model with URDF from Scratch}

In addition to the main body, thruster links can be defined with the \texttt{xacro:thruster\_link} tag, as  shown in the example.
The xyz position and the roll-pitch-yaw orientation between the main body and the thruster has to be indicated.

\subsection{AUV tags}

The URDF format was designed to define ground robots. In order to define a AUV, a gazebo plugin is used and will simulate thruster propulsion and hydrodynamic damping.
To simulate your own AUV design, update the \texttt{thruster} tags  in order to give the map that corresponds to your AUV. \\
At the end of the file we can also find a \texttt{buoyancy} tag that indicates the hydrodynamic properties of the robot body. The \texttt{origin} tag is used to set the center of buoyancy, that is usually above the center of gravity.

The hydrodynamic damping is defined with 6 coefficients that correspond to the moving directions.
In order to have damping values, we will make an assumption on the maximum velocity in each direction (that is a few m/s or 10 deg/s).
On each axis, this velocity limit is linked to the maximum force (or torque) and the corresponding damping coefficient with the following relation:
\begin{equation*}
 m\dot v = 0 = \tau_{\max} - k.v_{\lim{}}
\end{equation*}where $\tau_{\max}$ is the maximum effort or torque in this direction and depends on the chosen thruster positions.


\section{Low-level tuning}

Now that the URDF is written, we can use the launch file to run the simulation:
\begin{center}\defaultstyle
\begin{lstlisting}
roslaunch ecn_rasom auv.launch
\end{lstlisting}
\end{center}
The simulated AUV is waiting for data on the \texttt{body\_command} topic, which is computed from the \texttt{body\_setpoint} topic through PID's.\\
A generic tool interface in ROS can be run with:
\begin{center}\defaultstyle
\begin{lstlisting}
rosrun rqt_gui rqt_gui
\end{lstlisting}
\end{center}
Use the topic publisher plugin to send a position setpoint to your AUV. The Dynamic Reconfigure plugin can be used to change the PID gains withou exiting the simulator.
Once acceptable values have been found for the gains, you may update the \texttt{ecn\_auv\_control.yaml} file to set the default values.

\section{Waypoint following}


As the AUV is now capable of reaching a desired position, write a C++ program that makes the AUV cycle through several waypoints. \\
The message to publish is of type \texttt{freefloating\_gazebo/BodySetpoint} and has to be published on the topic \texttt{/ecn\_auv/body\_setpoint}.

The structure of such a message can be found through \texttt{rqt\_gui} or with:
\begin{center}\defaultstyle
\begin{lstlisting}
rosmsg show freefloating_gazebo/BodySetpoint
\end{lstlisting}
\end{center}
which gives:
\begin{center}\defaultstyle
\begin{lstlisting}
std_msgs/Header header
  uint32 seq
  time stamp
  string frame_id
string child_frame_id
geometry_msgs/Pose pose
  geometry_msgs/Point position
    float64 x
    float64 y
    float64 z
  geometry_msgs/Quaternion orientation
    float64 x
    float64 y
    float64 z
    float64 w
geometry_msgs/Twist twist
  geometry_msgs/Vector3 linear
    float64 x
    float64 y
    float64 z
  geometry_msgs/Vector3 angular
    float64 x
    float64 y
    float64 z
\end{lstlisting}
\end{center}we are only interested in the \texttt{pose} section as we give position setpoints.

Remember that the AUV may not reach perfectly the desired position, so you should cycle to the next waypoint when the position error is below a given threshold.
The current position of the AUV can be found on the topic \texttt{/ecn\_auv/state} and is of type \texttt{nav\_msgs/Odometry} with a structure similar to \texttt{freefloating\_gazebo/BodySetpoint}, and where we are also interested only
in the \texttt{pose} section.

\end{document}
